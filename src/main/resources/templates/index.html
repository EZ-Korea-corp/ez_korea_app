<!DOCTYPE html>
<html lang="ko"
      class="no-js"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns="http://www.w3.org/1999/html">

<body>

<main layout:fragment="main">
    <div class="lg:space-x-12">
        <div class="" id="body_div">
            <form th:action="@{/commute}" method="post" id="commuteForm">
                <input type="hidden" id="location" name="location" value=""/>
                <div class=" md:mb-4 mb-3" th:if="${!isOnTime}">
                    <h2 class="text-2xl font-semibold"> <span th:text="${member.getName()}"></span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</h2>
                    <p class="my-2">ì¶œê·¼ ì²˜ë¦¬ë¥¼ ë¨¼ì €í•œ ë’¤ ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</p>
                    <input type="hidden" name="commuteStatus" th:value="${T(com.ezkorea.hybrid_app.domain.user.commute.CommuteStatus).valueOf('ON_TIME').getKey()}"/>
                    <button type="button" id="onTimeBtn" class="text-white bg-blue-600 font-medium rounded-lg text-sm px-5 py-2.5 w-full">ì¶œê·¼ ì²´í¬</button>
                </div>
                <div class=" md:mb-4 mb-3" th:if="${isOnTime}">
                    <th:block th:if="${commute.getStatus().equals('onTime')}">
                        <h2 class="text-2xl font-semibold"> <span th:text="${member.getName()}"></span>ë‹˜ ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš” ğŸ’ª</h2>
                        <p class="my-2">â° ì¶œê·¼ ì‹œê°„ : <span th:text="${#temporals.format(commute.getOnTime(), 'HHì‹œ mmë¶„')}"></span></p>
                        <input type="hidden" name="commuteStatus" th:value="${T(com.ezkorea.hybrid_app.domain.user.commute.CommuteStatus).valueOf('OFF_TIME').getKey()}"/>
                        <button type="button" id="offTimeBtn" class="text-white bg-yellow-600 font-medium rounded-lg text-sm px-5 py-2.5 w-full">í‡´ê·¼í•˜ê¸° ğŸ˜</button>
                    </th:block>
                    <th:block th:if="${commute.getStatus().equals('offTime')}">
                        <h2 class="text-2xl font-semibold"> <span th:text="${member.getName()}"></span>ë‹˜ ì˜¤ëŠ˜ë„ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤ ğŸ™‡</h2>
                        <p class="my-2">â° í‡´ê·¼ ì‹œê°„ : <span th:text="${#temporals.format(commute.getOffTime(), 'HHì‹œ mmë¶„')}"></span></p>
                    </th:block>
                </div>
            </form>

            <hr class="my-5">

            <div class="flex justify-between">
                <h2 class="text-xl font-semibold mb-2"> ê³µì§€ì‚¬í•­ </h2>
                <p><a class="text-blue-500" th:href="@{/notice}">ë”ë³´ê¸°ï¸ </a></p>
            </div>

            <div class="card divide-y divide-gray-100 sm:m-0">

                <th:block th:if="${noticeList.size() != 0}">
                    <div class="p-7 sm:space-x-6" th:each="notice : ${noticeList}">
                        <div class="sm:order-2">
                            <a th:href="@{/notice/{id}(id = ${notice.getId()})}">
                                <h3 class="text-md font-medium mb-2" th:text="${notice.getTitle()}"> ê³µì§€ ì œëª© </h3>
                            </a>
                            <p class="text-sm" th:text="${#temporals.format(notice.getCreateDate(), 'yyyyë…„ MMì›” ddì¼ HHì‹œ mmë¶„')}">ì‘ì„±ì¼</p>
                        </div>
                    </div>
                </th:block>
                <th:block th:if="${noticeList.size() == 0}">
                    <div class="p-7 sm:space-x-6">
                        <div class="sm:order-2">
                            <a>
                                <h3 class="text-lg font-medium"> ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. </h3>
                            </a>
                        </div>
                    </div>
                </th:block>

            </div>


        </div>
    </div>
    <script>
        let locationStr = "";
        let submitFlag = true;

        function setLocation() {
            navigator.geolocation.getCurrentPosition(function (position){
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                submitFlag = true;
                locationStr = lat + ',' + lng;
            }, function (){
                Swal.fire({
                    icon: 'question',
                    html: 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì¹˜ ì •ë³´ í—ˆìš©ì„ í•´ì£¼ì„¸ìš”.',
                    footer: 'í•¸ë“œí° ì„¤ì • â¡ï¸ ìœ„ì¹˜ ì„œë¹„ìŠ¤ â¡ï¸ ì‚¬ìš©í•˜ëŠ” ë¸Œë¼ìš°ì € ìœ„ì¹˜ ì„œë¹„ìŠ¤ í—ˆìš© â¡ï¸ ë©”ì¸ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨'
                })
                submitFlag = false;
            });
        }

        $("#offTimeBtn").on("click", function (){
            Swal.fire({
                html: 'í‡´ê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                showDenyButton: true,
                confirmButtonText: 'í‡´ê·¼í•˜ê¸°',
                denyButtonText: `ë‹«ê¸°`,
            }).then((result) => {
                if(result.isConfirmed){
                    setTimeLoadingSpinner(5000, "ìœ„ì¹˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.");
                    setLocation();
                    setTimeout(function() {
                        $('#location').attr('value', locationStr);
                        if (submitFlag === true  && locationStr.length !== 0) {
                            $('#commuteForm').submit();
                        }
                    }, 5000);
                }
            })
        });

        $("#onTimeBtn").on("click", function (){
            Swal.fire({
                title: 'ì¶œê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                html: "'ìœ„ì¹˜ ì•¡ì„¸ìŠ¤ ê¶Œí•œ'ì„ í—ˆìš©í•˜ì‹  í›„ ì¶œê·¼ ì²´í¬ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.",
                showDenyButton: true,
                confirmButtonText: 'ì¶œê·¼í•˜ê¸°',
                denyButtonText: `ë‹«ê¸°`,
            }).then((result) => {
                if(result.isConfirmed){
                    setTimeLoadingSpinner(5000, "ìœ„ì¹˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.");
                    setLocation();
                    setTimeout(function() {
                        $('#location').attr('value', locationStr);
                        if (submitFlag === true  && locationStr.length !== 0) {
                            $('#commuteForm').submit();
                        }
                    }, 5000);
                }
            })
        });
    </script>
</main>

</body>

</html>